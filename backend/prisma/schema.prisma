generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// AUTHENTICATION MODELS


model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  username      String    @unique
  avatarUrl     String
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  refreshTokens           RefreshToken[]
  emailVerificationTokens EmailVerificationToken[]
  itineraries             UserItinerary[]

  @@index([email])
  @@index([username])
}

model RefreshToken {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

enum LocationClassification {
  HIDDEN_GEM
  CONDITIONAL
  TOURIST_TRAP
  MUST_SEE
}


enum LocationCategory {
  RESTAURANT
  CAFE
  BAR
  NIGHTCLUB
  BEACH
  HIKING
  HISTORICAL_SITE
  MUSEUM
  MARKET
  VIEWPOINT
  PARK
  RELIGIOUS_SITE
  SHOPPING
  ACTIVITY
  OTHER
}

enum PriceLevel {
  INEXPENSIVE
  MODERATE
  EXPENSIVE
}



model Place {
  id                  String   @id @default(cuid())
  name                String
  classification      LocationClassification
  category            LocationCategory
  description         String
  
  // Source tracking
  sources             String[]  // ["reddit", "tripadvisor", "tiktok"]
  sourceUrls          String[]
  popularity          Int       @default(0)
  
  // Google Places enrichment
  googlePlaceId       String?   @unique
  rating              Float?
  totalRatings        Int?
  priceLevel          PriceLevel?
  openingHours        Json?     // Stored as JSON
  topReviews          Json?     // Top 3 reviews as JSON array
  
  // Location
  latitude            Float
  longitude           Float
  address             String?
  city                String    // City name for filtering
  country             String    @default("Lebanon")
  
  // Cost estimates (from sources)
  costMinUSD          Float?
  costMaxUSD          Float?
  
  // Metadata
  activityTypes       String[]  // ["food", "culture", "nature", etc]
  bestTimeToVisit     String?
  localTip            String?
  scamWarning         String?
  
  // Images and reviews from sources
  imageUrl            String?   // Primary image from TripAdvisor or Google
  imageUrls           String[]  // Multiple images
  sourceReviews       Json?     // Curated reviews from Reddit/TripAdvisor as JSON
  
  // Data freshness
  lastEnrichedAt      DateTime?
  lastValidatedAt     DateTime?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  itineraryItems      ItineraryItem[]
  
  @@index([classification])
  @@index([city])
  @@index([googlePlaceId])
  @@index([country])
  @@index([city, classification])
  @@index([country, category])
}

// Structured Itinerary for RAG and versioning
model UserItinerary {
  id                  String   @id @default(cuid())
  userId              String?
  user                User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Trip details
  country             String
  airportCode         String
  numberOfDays        Int
  budgetUSD           Float
  travelStyles        String[] // ["food", "culture", "nature"]
  
  // Flight info for notifications
  flightDate          DateTime?
  notificationsEnabled Boolean  @default(false)
  
  // Versioning
  version             Int      @default(1)
  
  // Generated output
  totalEstimatedCostUSD Float?
  routeSummary        String?
  
  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  items               ItineraryItem[]
  checklist           ChecklistItem[]
  embeddings          ItineraryEmbedding[]
  
  @@index([userId])
  @@index([flightDate])
  @@index([country])
}

model ItineraryItem {
  id                  String   @id @default(cuid())
  
  dayNumber           Int
  orderInDay          Int
  
  // Duration and timing
  suggestedStartTime  String?  // "09:00"
  suggestedDuration   Int?     // minutes
  travelTimeFromPrev  Int?     // minutes
  
  notes               String?
  
  itineraryId         String
  itinerary           UserItinerary @relation(fields: [itineraryId], references: [id], onDelete: Cascade)
  
  placeId             String
  place               Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@unique([itineraryId, dayNumber, orderInDay])
  @@index([itineraryId])
  @@index([placeId])
  @@index([itineraryId, dayNumber, orderInDay])
}

model ChecklistItem {
  id                  String   @id @default(cuid())
  
  category            ChecklistCategory
  item                String
  reason              String?  // Why this item is recommended
  source              String?  // "weather", "terrain", "activity", etc.
  
  isChecked           Boolean  @default(false)
  
  itineraryId         String
  itinerary           UserItinerary @relation(fields: [itineraryId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([itineraryId])
  @@index([category])
}

enum ChecklistCategory {
  ESSENTIALS
  WEATHER
  TERRAIN
  ACTIVITY
  SAFETY
  DOCUMENTATION
}

// RAG Embeddings for itinerary Q&A
model ItineraryEmbedding {
  id              String   @id @default(cuid())

  itineraryId     String
  itinerary       UserItinerary @relation(fields: [itineraryId], references: [id], onDelete: Cascade)
  
  // Chunk info
  chunkIndex      Int
  chunkType       ChunkType
  chunkText       String     // Original text that was embedded
  
  // Metadata for filtering
  placeIds        String[]   // Place IDs referenced in this chunk
  dayNumbers      Int[]      // Days covered
  activityTypes   String[]   // Activity types in chunk
  

  embeddingJson   Json?      
  
  createdAt       DateTime @default(now())
  
  @@index([itineraryId])
  @@index([chunkType])
}

model KnowledgeEmbedding {
  id              String   @id @default(cuid())
  
  content         String   // The actual text content
  countryCode     String   // ISO alpha-2 "LB"
  source          String   // "reddit", "wikipedia", etc.
  
  // Metadata like author, url, activityTypes, popularity
  metadata        Json?    
  
  // Vector
  embeddingJson   Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([countryCode])
  @@index([source])
}

enum ChunkType {
  FULL_SUMMARY
  DAY_PLAN
  PLACE_DETAIL
  CHECKLIST
  ROUTE_OVERVIEW
}

